#!/usr/bin/env bash
# @cmd Set up development environment (install git hooks)
# @alias s
setup() {
  echo "Setting up pre-commit config..."
  if [ ! -f .pre-commit-config.yaml ]; then
    cp .pre-commit-config.yaml.template .pre-commit-config.yaml
    echo "✓ Created .pre-commit-config.yaml from template"
  else
    echo "✓ .pre-commit-config.yaml already exists"
  fi

  echo "Installing git hooks..."
  prek install
  echo "✅ Development environment ready"
}

# @cmd Create a release zip file
# @alias r
release() {
  echo "Building Rust binary..."
  cargo build --release
  echo ""
  echo "Building release zip..."
  nix build
  echo "✅ Release ready: result/yx.zip"
}

# @cmd Build a Linux release via Nix cross-compilation (for testing installer on macOS)
# @alias rl
release-linux() {
  echo "Building Linux release via Nix cross-compilation..."

  # Build Linux package on macOS via Nix cross-compilation
  nix build .#packages.x86_64-linux.default

  # Copy to expected location for tests
  mkdir -p result-linux
  cp result/yx.zip result-linux/yx-linux.zip

  echo "✓ Linux release built: result-linux/yx-linux.zip"
}

# @cmd Run linting (shellcheck + Rust clippy + rustfmt)
# @alias l
lint() {
  local exit_code=0

  echo "Running shellcheck..."
  # Find and check all .sh files
  while IFS= read -r -d '' file; do
    if ! shellcheck -S warning "$file"; then
      exit_code=1
    fi
  done < <(find . -name "*.sh" -print0)

  echo ""
  echo "Running Rust clippy..."
  if ! cargo clippy -- -D warnings; then
    exit_code=1
  fi

  echo ""
  echo "Running Rust format check..."
  if ! cargo fmt --check; then
    exit_code=1
  fi

  return $exit_code
}

# @cmd Run tests (shellspec)
# @alias t
test() {
  # Build Linux release for installer test
  echo "Building Linux release for installer test..."
  release-linux || {
    echo "Failed to build Linux release"
    return 1
  }
  echo ""

  shellspec
  cargo test
}

# @cmd Run all checks (tests + lint + audit) and mark as verified
# @alias c
check() {
  echo "Running acceptance tests..."
  if ! shellspec; then
    echo "❌ Acceptance tests failed"
    return 1
  fi

  echo "Running unit tests..."
  if ! cargo test; then
    echo "❌ Unit tests failed"
    return 1
  fi

  echo ""
  echo "Running linter..."
  if ! lint; then
    echo "❌ Linting failed"
    return 1
  fi

  echo ""
  echo "Running security audit..."
  if command -v cargo-audit >/dev/null 2>&1; then
    if ! cargo audit; then
      echo "❌ Security audit failed"
      return 1
    fi
  else
    echo "⚠️  cargo-audit not installed (run: cargo install cargo-audit)"
    echo "   Skipping security audit check"
  fi

  echo ""
  touch .last-checked
  echo "✅ All checks passed - changes verified"
}

# @cmd Run Ralph Wiggum loop (iterations with pause)
# @option --max-iterations <NUM> Number of iterations to run (default: 20)
ralph() {
  local max_iterations="${argc_max_iterations:-20}"

  for ((i=1; i<=max_iterations; i++)); do
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo " Iteration $i/$max_iterations"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    echo prompt.md | claude -p --allowedTools "Read,Write,Edit"
  done
}

eval "$(argc --argc-eval "$0" "$@")"
