#!/usr/bin/env bash
# @cmd Set up development environment (install git hooks)
# @alias s
setup() {
  echo "Setting up pre-commit config..."
  if [ ! -f .pre-commit-config.yaml ]; then
    cp .pre-commit-config.yaml.template .pre-commit-config.yaml
    echo "✓ Created .pre-commit-config.yaml from template"
  else
    echo "✓ .pre-commit-config.yaml already exists"
  fi

  echo "Installing git hooks..."
  prek install
  echo "✅ Development environment ready"
}

# @cmd Create a release zip file
# @alias r
release() {
  echo "Building Rust binary..."
  cargo build --release
  echo ""
  echo "Building release zip..."
  nix build
  echo "✅ Release ready: result/yx.zip"
}

# @cmd Build a Linux release in Docker (for testing installer on macOS)
# @alias rl
release-linux() {
  echo "Building Linux release in Docker..."

  # Create a temporary directory for the build
  local build_dir
  build_dir=$(mktemp -d)
  trap 'rm -rf "$build_dir"' EXIT

  # Detect the Docker platform architecture
  local docker_arch
  docker_arch=$(docker run --rm busybox uname -m)
  local rust_target
  case "$docker_arch" in
    x86_64)
      rust_target="x86_64-unknown-linux-musl"
      ;;
    aarch64)
      rust_target="aarch64-unknown-linux-musl"
      ;;
    *)
      echo "Error: Unsupported Docker architecture: $docker_arch"
      return 1
      ;;
  esac

  # Create a Dockerfile for static build using musl
  cat > "$build_dir/Dockerfile" <<EOF
FROM rust:alpine
WORKDIR /workspace

# Install musl-dev and other build dependencies
RUN apk add --no-cache musl-dev pkgconfig openssl-dev openssl-libs-static zip

COPY . .

# Build static binary
RUN cargo build --release --target $rust_target

# Create release zip
RUN mkdir -p /output/release-bundle/bin /output/release-bundle/completions && \\
    cp target/$rust_target/release/yx /output/release-bundle/bin/yx && \\
    chmod +x /output/release-bundle/bin/yx && \\
    cp -r completions/* /output/release-bundle/completions/ && \\
    cd /output/release-bundle && \\
    zip -r /output/yx-linux.zip .
EOF

  # Copy source files
  rsync -a --exclude='.git' --exclude='result' --exclude='result-linux' \
    --exclude='.yaks' --exclude='node_modules' --exclude='.worktrees' \
    --exclude='target' \
    ./ "$build_dir/"

  # Build in Docker
  echo "Building static binary for $rust_target..."
  docker build -t yx-linux-builder "$build_dir" || {
    echo "Error: Docker build failed"
    return 1
  }

  # Extract the release zip
  mkdir -p result-linux
  # Create a temporary container to extract the file
  container_id=$(docker create yx-linux-builder)
  docker cp "$container_id:/output/yx-linux.zip" result-linux/yx-linux.zip
  docker rm "$container_id" >/dev/null

  # Clean up Docker image
  docker rmi yx-linux-builder >/dev/null 2>&1 || true

  echo "✓ Linux release built (static $rust_target): result-linux/yx-linux.zip"
}

# @cmd Run linting (shellcheck + Rust clippy + rustfmt)
# @alias l
lint() {
  local exit_code=0

  echo "Running shellcheck..."
  # Find and check all .sh files
  while IFS= read -r -d '' file; do
    if ! shellcheck -S warning "$file"; then
      exit_code=1
    fi
  done < <(find . -name "*.sh" -print0)

  echo ""
  echo "Running Rust clippy..."
  if ! cargo clippy -- -D warnings; then
    exit_code=1
  fi

  echo ""
  echo "Running Rust format check..."
  if ! cargo fmt --check; then
    exit_code=1
  fi

  return $exit_code
}

# @cmd Run tests (shellspec)
# @alias t
test() {
  # Build Linux release for installer test
  echo "Building Linux release for installer test..."
  release-linux || {
    echo "Failed to build Linux release"
    return 1
  }
  echo ""

  shellspec
  cargo test
}

# @cmd Run all checks (tests + lint + audit) and mark as verified
# @alias c
check() {
  echo "Running acceptance tests..."
  if ! shellspec; then
    echo "❌ Acceptance tests failed"
    return 1
  fi

  echo "Running unit tests..."
  if ! cargo test; then
    echo "❌ Unit tests failed"
    return 1
  fi

  echo ""
  echo "Running linter..."
  if ! lint; then
    echo "❌ Linting failed"
    return 1
  fi

  echo ""
  echo "Running security audit..."
  if command -v cargo-audit >/dev/null 2>&1; then
    if ! cargo audit; then
      echo "❌ Security audit failed"
      return 1
    fi
  else
    echo "⚠️  cargo-audit not installed (run: cargo install cargo-audit)"
    echo "   Skipping security audit check"
  fi

  echo ""
  touch .last-checked
  echo "✅ All checks passed - changes verified"
}

# @cmd Run Ralph Wiggum loop (iterations with pause)
# @option --max-iterations <NUM> Number of iterations to run (default: 20)
ralph() {
  local max_iterations="${argc_max_iterations:-20}"

  for ((i=1; i<=max_iterations; i++)); do
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo " Iteration $i/$max_iterations"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    echo prompt.md | claude -p --allowedTools "Read,Write,Edit"
  done
}

eval "$(argc --argc-eval "$0" "$@")"
